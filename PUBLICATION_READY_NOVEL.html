<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEEPING TIME | Volume 1: The Impulse - Complete Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @page { size: 6in 9in; margin: 0.75in; }
        
        :root {
            --accent: #00f3ff;
            --accent-glow: rgba(0, 243, 255, 0.3);
            --gold: #ffcc33;
            --text: #1a1a1a;
            --bg: #ffffff;
            --sidebar-bg: #f8f9fa;
            --system-bg: #f0f2f5;
            --border: #ddd;
            --font-main: 'Crimson Pro', serif;
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --max-width: 700px;
            --transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --pulse-rate: 2s;
            --fracture-lean: 0deg;
        }

        [data-theme="dark"] {
            --text: #e0e0e0;
            --bg: #0a0a0c;
            --sidebar-bg: #151518;
            --system-bg: #1a1a1d;
            --border: #333;
            --accent-glow: rgba(0, 243, 255, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-main);
            line-height: 1.8;
            color: var(--text);
            background: var(--bg);
            transition: background-color var(--transition), color var(--transition);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            padding-left: 320px;
        }

        main {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 120px 24px;
        }

        .nav-ui {
            position: fixed;
            top: 0;
            left: 320px;
            width: calc(100% - 320px);
            z-index: 1000;
            background: rgba(var(--bg), 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            transition: transform 0.3s ease, background-color var(--transition);
        }

        .nav-ui.hidden { transform: translateY(-100%); }

        .progress-container {
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--border);
        }

        .progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            box-shadow: 0 0 10px var(--accent-glow);
            transition: width 0.1s linear;
        }

        .nav-controls { display: flex; gap: 16px; align-items: center; }

        .ui-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }

        .ui-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 900; }
        
        header.title-page {
            height: 90vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-bottom: 1px solid var(--border);
            margin-bottom: 100px;
        }

        h1 { 
            font-size: clamp(3rem, 10vw, 5rem); 
            text-transform: uppercase; 
            letter-spacing: 0.25em; 
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--text) 30%, var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle { 
            font-size: 1.2rem; 
            opacity: 0.6; 
            letter-spacing: 0.4em;
            font-weight: 400;
            margin-bottom: 64px;
        }

        h3 { 
            font-size: clamp(1.8rem, 5vw, 2.5rem); 
            margin: 160px 0 80px; 
            text-align: center; 
            text-transform: uppercase; 
            letter-spacing: 0.15em;
        }

        h3::before {
            content: '';
            display: block;
            width: 40px;
            height: 2px;
            background: var(--accent);
            margin: 0 auto 32px;
        }

        h4 { 
            font-size: 0.9rem; 
            margin: 60px 0 32px; 
            text-transform: uppercase; 
            letter-spacing: 0.2em; 
            color: var(--accent);
            font-family: var(--font-mono);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h4::after {
            content: '';
            flex-grow: 1;
            height: 1px;
            background: var(--border);
        }

        p { 
            margin: 2em 0; 
            text-align: justify; 
            font-size: 1.25rem;
            color: var(--text);
            opacity: 0.95;
        }

        .chapter {
            margin-bottom: 200px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .chapter.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        .system-block {
            font-family: var(--font-mono);
            background: var(--system-bg);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            padding: 32px;
            margin: 48px 0;
            font-size: 0.9rem;
            line-height: 1.6;
            border-radius: 4px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .toc-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 2000; display: none; padding: 80px 24px; overflow-y: auto;
        }
        .toc-modal.active { display: block; }
        .toc-list { list-style: none; max-width: 600px; margin: 0 auto; }
        .toc-list li { margin: 24px 0; }
        .toc-list a { text-decoration: none; color: var(--text); font-family: var(--font-display); font-size: 1.4rem; transition: color 0.2s; }
        .toc-list a:hover { color: var(--accent); }

        .back-to-top {
            position: fixed; bottom: 32px; right: 32px; width: 48px; height: 48px; background: var(--bg);
            border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; z-index: 1000; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: var(--text);
        }
        .back-to-top.visible { opacity: 1; visibility: visible; }
        .back-to-top:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-4px); }

        /* --- ORGANISM SYSTEM CSS --- */
        .ui-fracture {
            position: fixed; bottom: 80px; right: 24px; width: 2px;
            height: var(--fracture-height, 0px); z-index: 900; pointer-events: none;
            transition: height 0.3s ease-out, transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            transform: rotate(var(--fracture-lean, 0deg));
        }
        .main-crack {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, transparent 0%, rgba(0, 243, 255, 0.12) 15%, rgba(0, 243, 255, 0.12) 85%, transparent 100%);
            box-shadow: 0 0 1px rgba(0, 243, 255, 0.08);
        }
        .branch {
            position: absolute; width: 1px; height: 0; background: rgba(0, 243, 255, 0);
            opacity: 0; transition: all 1.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ui-fracture[data-intensity="1"] .branch-1 { opacity: 1; height: 35px; background: rgba(0, 243, 255, 0.18); transform: rotate(-27deg); bottom: 38%; left: 0; }
        .ui-fracture[data-intensity="2"] .branch-2 { opacity: 1; height: 30px; background: rgba(0, 243, 255, 0.2); transform: rotate(33deg); bottom: 62%; left: 0; }
        .ui-fracture[data-intensity="3"] .branch-3 { opacity: 1; height: 25px; background: rgba(0, 243, 255, 0.25); transform: rotate(-19deg); bottom: 18%; left: 0; }
        .ui-fracture.healing-blocked { animation: blockedPulse 2s ease-in-out infinite; }
        @keyframes blockedPulse { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.2) saturate(1.1); } }

        .surveillance-indicator {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%); width: 2px; height: 0;
            background: var(--accent); opacity: 0; z-index: 900;
            transition: height 0.3s steps(5), opacity 0.2s steps(3);
        }
        .surveillance-indicator.scanning::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--accent); animation: scanLine 2s linear infinite;
        }
        @keyframes scanLine { 0% { top: 0; } 100% { top: 100%; } }

        #residual-archive {
            position: fixed; left: 0; top: 0; width: 320px; height: 100vh;
            background: rgba(var(--bg-rgb), 0.95); border-right: 1px solid var(--accent);
            z-index: 1500; overflow-y: auto; display: flex; flex-direction: column;
            justify-content: center; backdrop-filter: blur(8px);
        }
        .resonance-monitor {
            position: absolute; top: 0; left: 0; width: 2px; height: 100%;
            background: var(--accent); opacity: 0.3;
        }
        .resonance-monitor.active { animation: systole var(--pulse-rate) infinite cubic-bezier(0.4, 0, 0.2, 1); }
        .resonance-monitor.high-stress { animation: systole var(--pulse-rate) infinite cubic-bezier(0.4, 0, 0.2, 1), microJitter 0.3s infinite; }
        @keyframes microJitter { 0%, 100% { transform: scaleX(1); } 50% { transform: scaleX(1.02); } }
        @keyframes systole { 0%, 100% { opacity: 0.2; transform: scaleX(1); } 15% { opacity: 0.8; transform: scaleX(2); } }

        .residual-layer { padding: 40px 24px; display: flex; flex-direction: column; gap: 2rem; }
        .archive-entry { font-family: var(--font-mono); font-size: 0.7rem; margin-bottom: 12px; padding: 8px; border-left: 2px solid var(--accent); background: rgba(0,0,0,0.05); }
        .fragment-display-container { position: fixed; bottom: 120px; right: 80px; width: 300px; max-width: 40vw; z-index: 800; pointer-events: none; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        .narrative-fragment { background: rgba(var(--bg-rgb), 0.85); backdrop-filter: blur(8px); border: 1px solid var(--accent); border-radius: 4px; padding: 12px 16px; opacity: 0; transform: translateX(20px); transition: all 0.8s ease; }
        .narrative-fragment.visible { opacity: 1; transform: translateX(0); }
        .fragment-text { font-family: var(--font-main); font-size: 0.9rem; font-style: italic; }

        /* Tooltips */
        .tooltip {
            position: relative;
            border-bottom: 1px dashed var(--accent);
            cursor: help;
            color: var(--accent);
            transition: all 0.3s ease;
        }

        .tooltip::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(255, 255, 255, 0.95);
            color: var(--text);
            padding: 8px 12px;
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: var(--font-mono);
            white-space: normal;
            width: max-content;
            max-width: 250px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            box-shadow: 0 4px 15px var(--accent-glow);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(4px);
        }

        [data-theme="dark"] .tooltip::after {
            background: rgba(10, 10, 12, 0.95);
        }

        .tooltip:hover {
            background: var(--accent-glow);
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        @media (max-width: 768px) {
            body { padding-left: 0; }
            .nav-ui { left: 0; width: 100%; }
            main { padding: 80px 20px; }
            .back-to-top { bottom: 20px; right: 20px; width: 40px; height: 40px; }
            #residual-archive { width: 100%; height: 80px; bottom: 0; top: auto; flex-direction: row; border-right: none; border-top: 1px solid var(--accent); }
        }
    </style>
</head>
<body>
    <nav class="nav-ui" id="main-nav">
        <div class="nav-brand" style="font-family: var(--font-display); font-weight: 900; letter-spacing: 2px;">KEEPING TIME</div>
        <div class="nav-controls">
            <button class="ui-btn" onclick="toggleTOC()" aria-label="Open chapters menu">Chapters</button>
            <button class="ui-btn" onclick="toggleTheme()" id="theme-icon" aria-label="Toggle dark mode">Theme</button>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="reading-progress"></div>
        </div>
    </nav>

    <div class="ui-fracture" id="ui-fracture" data-intensity="0">
        <span class="main-crack"></span>
        <span class="branch branch-1"></span>
        <span class="branch branch-2"></span>
        <span class="branch branch-3"></span>
    </div>
    <div class="surveillance-indicator" id="surveillance"></div>
    <aside id="residual-archive"><div class="resonance-monitor"></div><div class="residual-layer" id="residual-layer"></div></aside>

    <button class="back-to-top" id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" aria-label="Back to top">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
    </button>

    <div class="toc-modal" id="toc-modal">
        <button class="ui-btn" onclick="toggleTOC()" style="position: absolute; top: 24px; right: 24px;">Close</button>
        <ul class="toc-list">
            <li><a href="#ch1" onclick="toggleTOC()">Chapter 1: The Zap</a></li>
            <li><a href="#ch2" onclick="toggleTOC()">Chapter 2: The Assessment</a></li>
            <li><a href="#ch3" onclick="toggleTOC()">Chapter 3: Modulation</a></li>
            <li><a href="#ch4" onclick="toggleTOC()">Chapter 4: The Medium</a></li>
            <li><a href="#ch5" onclick="toggleTOC()">Chapter 5: The Sync Check</a></li>
            <li><a href="#ch6" onclick="toggleTOC()">Chapter 6: The Ground State</a></li>
            <li><a href="#ch7" onclick="toggleTOC()">Chapter 7: The Rival</a></li>
            <li><a href="#ch8" onclick="toggleTOC()">Chapter 8: The Sortie</a></li>
            <li><a href="#ch9" onclick="toggleTOC()">Chapter 9: The Silence</a></li>
            <li><a href="#ch10" onclick="toggleTOC()">Chapter 10: The Breach</a></li>
            <li><a href="#ch11" onclick="toggleTOC()">Chapter 11: The Blue Screen</a></li>
            <li><a href="#ch12" onclick="toggleTOC()">Chapter 12: The Audit</a></li>
            <li><a href="#ch13" onclick="toggleTOC()">Chapter 13: The Patch</a></li>
            <li><a href="#ch14" onclick="toggleTOC()">Chapter 14: The Return</a></li>
            <li><a href="#ch15" onclick="toggleTOC()">Chapter 15: The Phantom Mesh</a></li>
            <li><a href="#ch16" onclick="toggleTOC()">Chapter 16: Illegal Modulations</a></li>
            <li><a href="#ch17" onclick="toggleTOC()">Chapter 17: The Underground</a></li>
        </ul>
    </div>

    <main id="main-content">
<header class="title-page">
    <h1>KEEPING TIME</h1>
    <div class="subtitle">VOLUME 1: THE IMPULSE</div>
    <p style="font-family: var(--font-mono); font-size: 0.9rem; letter-spacing: 0.3em; margin-top: 32px;">
        <span style="opacity: 0.4; text-decoration: line-through;">By the Architect</span>
        <br>
        <span style="color: var(--accent); font-weight: bold;">> OVERRIDE: TheDonCipher</span>
    </p>
    </header>
    <!-- NOTE: Full chapter content goes here -->
    </main>

    <script>
const NarrativeState = {
  emotionalLoad: 0, lastEmotionalDelta: 0, surveillanceLevel: 0, systemPressure: 0, fractureLevel: 0, 
  stressMemory: 0, lastDominantForce: null, instabilityIndex: 0, interferenceActive: false,
  getSnapshot() { return { ...this }; }
};

const NARRATIVE_SIGNALS = {
  "ch01_zap": { range: [0.00, 0.06], emotional_load: 0.85, system_pressure: 0.20, surveillance: 0.10, heartbeat_bpm: 110 },
  "ch02_assessment": { range: [0.06, 0.12], emotional_load: 0.70, system_pressure: 0.95, surveillance: 1.00, heartbeat_bpm: 55 },
  "ch03_modulation": { range: [0.12, 0.18], emotional_load: 0.60, system_pressure: 0.80, surveillance: 0.40, heartbeat_bpm: 75 },
  "ch04_medium": { range: [0.18, 0.25], emotional_load: 0.75, system_pressure: 0.90, surveillance: 0.70, heartbeat_bpm: 90 },
  "ch05_sync_check": { range: [0.25, 0.31], emotional_load: 0.55, system_pressure: 0.60, surveillance: 0.50, heartbeat_bpm: 85 },
  "ch06_ground_state": { range: [0.31, 0.37], emotional_load: 0.40, system_pressure: 0.50, surveillance: 0.30, heartbeat_bpm: 65 },
  "ch07_rival": { range: [0.37, 0.40], emotional_load: 0.70, system_pressure: 0.85, surveillance: 0.80, heartbeat_bpm: 140 },
  "ch08_sortie": { range: [0.40, 0.45], emotional_load: 0.65, system_pressure: 0.75, surveillance: 0.85, heartbeat_bpm: 95 },
  "ch09_silence": { range: [0.45, 0.50], emotional_load: 0.90, system_pressure: 0.05, surveillance: 0.00, heartbeat_bpm: 160 },
  "ch10_breach": { range: [0.50, 0.55], emotional_load: 0.95, system_pressure: 0.00, surveillance: 0.00, heartbeat_bpm: 180 },
  "ch11_safe_mode": { range: [0.55, 0.62], emotional_load: 0.75, system_pressure: 0.30, surveillance: 0.60, heartbeat_bpm: 20 },
  "ch12_audit": { range: [0.62, 0.70], emotional_load: 0.85, system_pressure: 1.00, surveillance: 1.00, heartbeat_bpm: 45 },
  "ch13_patch": { range: [0.70, 0.78], emotional_load: 0.50, system_pressure: 0.95, surveillance: 0.95, heartbeat_bpm: 60 },
  "ch14_return": { range: [0.78, 0.83], emotional_load: 0.70, system_pressure: 0.85, surveillance: 0.90, heartbeat_bpm: 75 },
  "ch15_phantom_mesh": { range: [0.83, 0.88], emotional_load: 0.80, system_pressure: 0.75, surveillance: 0.60, heartbeat_bpm: 95 },
  "ch16_illegal_modulations": { range: [0.88, 0.93], emotional_load: 0.60, system_pressure: 0.50, surveillance: 0.40, heartbeat_bpm: 80 },
  "ch17_underground": { range: [0.93, 1.00], emotional_load: 0.55, system_pressure: 0.00, surveillance: 0.00, heartbeat_bpm: 70 }
};

var lastScrollY = window.scrollY, scrollPercent = 0, maxFractureHeight = 0, maxFractureIntensity = 0, hasHealed = false;

class NarrativeEventBus {
  constructor() { this.listeners = {}; this.fragmentRegistry = []; this.archiveLog = []; }
  on(e, h) { if (!this.listeners[e]) this.listeners[e] = []; this.listeners[e].push(h); }
  emit(e, d) { if (this.listeners[e]) this.listeners[e].forEach(h => h(d)); }
}
const narrativeEvents = new NarrativeEventBus();

class FragmentGenerator {
  constructor(eb) {
    this.eb = eb;
    this.templates = {
      intensity_1: [{ pattern: 'signal_lost', keywords: ['static', 'disconnect', 'searching'] }, { pattern: 'control_slip', keywords: ['governor', 'override', 'limit'] }],
      intensity_2: [{ pattern: 'system_rejection', keywords: ['error', 'incompatible', 'delete'] }, { pattern: 'memory_bleed', keywords: ['mother', 'before', 'forgotten'] }],
      intensity_3: [{ pattern: 'reality_tear', keywords: ['void', 'unravel', 'source'] }, { pattern: 'identity_fracture', keywords: ['noise', 'silence', 'neither'] }]
    };
    this.eb.on('fracture:branch', d => this.generate(d));
  }
  initialize() {
    this.container = document.getElementById('fragment-container') || document.createElement('div');
    this.container.id = 'fragment-container'; this.container.className = 'fragment-display-container';
    document.body.appendChild(this.container);
  }
  generate(d) {
    const tSet = this.templates[`intensity_${d.intensity}`] || this.templates.intensity_1;
    const t = tSet[Math.floor(Math.random() * tSet.length)];
    const keywords = t.keywords;
    let text = keywords.join(' / ');
    switch (t.pattern) {
      case 'signal_lost': text = `${keywords[0]} / between / the notes`; break;
      case 'control_slip': text = `the ${keywords[0]} / is / failing`; break;
      case 'system_rejection': text = `${keywords[0]}: you are / ${keywords[1]}`; break;
      case 'memory_bleed': text = `her voice / ${keywords[0]} / now only / ${keywords[2]}`; break;
      case 'reality_tear': text = `the ${keywords[0]} / beneath / reality`; break;
      case 'identity_fracture': text = `am I / ${keywords[0]} / or / ${keywords[1]}`; break;
    }
    const fragment = { id: Date.now(), text, intensity: d.intensity, pattern: t.pattern };
    this.eb.fragmentRegistry.push(fragment); this.eb.emit('fragment:generated', fragment);
    const el = document.createElement('div'); el.className = 'narrative-fragment visible';
    el.innerHTML = `<span class="fragment-text">${text}</span>`;
    this.container.appendChild(el); setTimeout(() => el.remove(), 8000);
  }
}

class ResidualArchive {
  constructor(eb) { this.eb = eb; this.eb.on('fragment:generated', f => setTimeout(() => this.capture(f), 500)); }
  initialize() {
    this.el = document.getElementById('archive-log') || document.createElement('div');
    this.el.id = 'archive-log'; this.el.className = 'archive-log-container';
    const s = document.getElementById('residual-archive'); if (s) s.appendChild(this.el);
  }
  capture(f) {
    let inst = "";
    switch (f.pattern) {
      case 'signal_lost': inst = "signal anomaly / standard deviation / logged"; break;
      case 'control_slip': inst = "containment protocol / deviation detected / adjusting"; break;
      case 'system_rejection': inst = "incompatibility event / subject flagged / processing"; break;
      case 'memory_bleed': inst = "memory access event / logged / within parameters"; break;
      case 'reality_tear': inst = "perception error / severe / medical intervention required"; break;
      case 'identity_fracture': inst = "personality coherence: unstable / intervention: authorized"; break;
      default: inst = "anomaly detected / classification: pending";
    }
    if (NarrativeState.surveillanceLevel > 0.7) inst = inst.split(' / ').slice(0, 2).join(' / ').toLowerCase();
    const entry = document.createElement('div'); entry.className = 'archive-entry';
    entry.innerHTML = `<div class="entry-text">${inst}</div>`;
    this.el.insertBefore(entry, this.el.firstChild);
  }
}

const fragmentGenerator = new FragmentGenerator(narrativeEvents);
const residualArchive = new ResidualArchive(narrativeEvents);

function updateFractureSystem() {
  const section = getCurrentSection(scrollPercent);
  const s = NARRATIVE_SIGNALS[section] || { emotional_load: 0, surveillance: 0 };
  NarrativeState.emotionalLoad = s.emotional_load;
  NarrativeState.surveillanceLevel = s.surveillance;

  const h = scrollPercent * (window.innerHeight - 160);
  if (h > maxFractureHeight) { 
    maxFractureHeight = h; 
    document.getElementById('ui-fracture').style.setProperty('--fracture-height', `${h}px`); 
  }

  let intensity = s.emotional_load > 0.95 ? 3 : s.emotional_load > 0.85 ? 2 : s.emotional_load > 0.7 ? 1 : 0;
  if (intensity > maxFractureIntensity) { 
    maxFractureIntensity = intensity; 
    document.getElementById('ui-fracture').setAttribute('data-intensity', intensity); 
    narrativeEvents.emit('fracture:branch', { intensity }); 
  }
  const force = NarrativeState.emotionalLoad > NarrativeState.surveillanceLevel ? 'internal' : 'external';
  document.getElementById('ui-fracture').style.setProperty('--fracture-lean', force === 'external' ? '-2deg' : '1deg');
}

function getCurrentSection(p) { for (const [k, s] of Object.entries(NARRATIVE_SIGNALS)) if (p >= s.range[0] && p < s.range[1]) return k; return "ch01_zap"; }
function toggleTheme() { const b = document.body; const t = b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; b.setAttribute('data-theme', t); localStorage.setItem('novel-theme', t); }
function toggleTOC() { const m = document.getElementById('toc-modal'); if (m) { const a = m.classList.toggle('active'); document.body.style.overflow = a ? 'hidden' : ''; } }

function onScroll() {
  const max = document.documentElement.scrollHeight - window.innerHeight;
  scrollPercent = max > 0 ? window.scrollY / max : 0;
  updateFractureSystem();
  const el = document.getElementById('surveillance'); if (el) { let s = NarrativeState.surveillanceLevel; el.style.height = s > 0.3 ? `${s * 200}px` : '0'; el.style.opacity = s > 0.3 ? (s * 0.4).toString() : '0'; if (s > 0.7) el.classList.add('scanning'); else el.classList.remove('scanning'); }
  document.querySelectorAll('.chapter').forEach(el => { if (el.getBoundingClientRect().top <= window.innerHeight * 0.85) el.classList.add('revealed'); });
}

function init() {
  fragmentGenerator.initialize(); residualArchive.initialize();
  window.addEventListener('scroll', onScroll, { passive: true });
  document.body.setAttribute('data-theme', localStorage.getItem('novel-theme') || 'light');
  onScroll();
}
document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', init) : init();
    </script>
</body>
</html>
